﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿﻿# Under Construction- - -﻿﻿﻿﻿# How to Install and Configure the OPC-UA Publisher on IoT Edge- - -## Assumptions- - -1.  An IoT Hub has been setup and configured in an Azure subscription that you have access to.  If you need to understand how to configure an IoT Hub see this [article](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-create-through-portal).  2.  An Azure IoT Edge device has been configured on a device that is running Linux.   - If you need to understand how to install IoT Edge on x64 see this [article](https://docs.microsoft.com/en-us/azure/iot-edge/how-to-install-iot-edge-linux).   - If you need help on how to install IoT Edge on Linux ARM32 see this [article](https://docs.microsoft.com/en-us/azure/iot-edge/how-to-install-iot-edge-linux-arm).## Install the OPC-UA Publisher- - - Once the Edge is running on a device (or VM) we need to ensure that it is healthy.  To do this run the following command```bashsudo systemctl status iotedge```You should see an output like you see below: ![image](Pictures/1.png)The part to pay attention to is the bit in green "active (running)"  This tells us that IoT Edge is installed and connected to an IoT Hub in Azure.Next we need to create a file for the OPC Publisher configuration.  From the shell prompt in the terminal session type the following:```bashsudo mkdir /shared```Now we need to create our file in this directory.  To do this we will type:```bashsudo nano /shared/pn.json```If nano is not your favorite editor...feel free to use what you like.paste the following in the file.```json[  {    "EndpointUrl": "opc.tcp://1xx.1xx.1xx.1xx:",Port    "UseSecurity": false,    "OpcNodes": [      {        "Id": "ns=2;s=Channel1.Device1.Tag1",        "OpcSamplingInterval": 2000,        "OpcPublishingInterval": 5000      }    ]  }]```Enter your OPC-UA Server's IP address and port number for the "EndpointURL".  Save this file.## Deconstructing the pn.json file- - - **EndpointUrl** entry must contain the <b>opc.tcp://</b> followed by the server's OPC server's IP address <b>:</b> and the OPC server's Port number.**UseSecurity** **OpcNodes** This is where you enter your Name Space and tags that you are wanting to sample and publish - **ID** This is where we will insert the OPC namespace and tags.  The easiest way to find the tag and name space is to use a tool like [UA Expert](https://www.unified-automation.com/downloads/opc-ua-clients.html).  For our discussions we will be using this tool.  Once the tool is installed, open the tool.  Once the tool starts up you will be asked to create a certificate.  Enter the required data.  Once UA Expert gets to the application view perform the following steps: - ![image](Pictures/12.png)- Then click <img src="Pictures/15.png" alt="OK" width="70px"/>- Now you should see your OPC Server listed under the "Servers" folder: - <img src="Pictures/16.png" alt="Project Window" width="250"/>- Right click on the OPC Server and select connect: - <img src="Pictures/17.png" alt="ServerConnect" width="170"/>- Now UA Expert should connect to your OPC Server.  Once it does you can see the following "tree view" at the bottom pane: - <img src="Pictures/18.png" alt="Tag Tree" width="250"/>- Use the tree view to navigate to the tags that you are looking for and then drag them to the center pane.   - <img src="Pictures/19.png" alt="Tree Drag" width="600"/>- In the following picture shows the **"ID"** section information.  The  NS shows the name space number "NS=2".  The **"String"** is the "s" after the **";"**.  and then everything in the third box makes up the rest of the string. - <img src="Pictures/20.png" alt="String Lay Out"/>The next step is to install the module for OPC-UA Publisher.  To do this you will need to log into the [Azure Portal](portal.azure.com).  Once you are on the Azure portal navigate to the resource group that holds your IoT Hub and select the IoT Hub. ![image](Pictures/2.png)On the IoT Hub blade select the IoT Edge on the left hand side. ![image](Pictures/3.png)On the IoT Edge blade find the IoT Edge device that we will be adding the OPC-UA Publisher to. ![image](Pictures/4.png)Select "Set Modules" at the top ![image](Pictures/5.png)Click on the Add as seen below: ![image](Pictures/6.png)Click on "Edge Module". ![image](Pictures/7.png)This will open a new fly out as scene below. ![image](Pictures/8.png)Here we will be filling in the following:1.  Name - iot-edge-opc-publisher2.  Image URI - microsoft/iot-edge-opc-publisher:latest3.  Container Create Options  - Enter the following replacing the port binding port to the one that you are using in your OPC server deployment.  Replace the <OPC Server Host Name and IP> with the OPC Server name and IP address as such:  “KeithOPCserver1.useast.cloudapp.azure.com:10x.2xx.6x.1”```json{    "Hostname": "publisher",    "Cmd": [      "publisher",      "--pf",      "/cfg/pn.json",      "--aa"    ],    "HostConfig": {      "PortBindings": {        "62222/tcp": [          {            "HostPort": "62222"          }        ]      },      "Binds": [        "test_cfx509certstores:/root/.dotnet/corefx/cryptography/x509stores",        "/shared:/cfg"      ],      "ExtraHosts": [      "<OPC Server Host Name and IP>"      ]    }  }```and click ![image](Pictures/8.png).At the bottom of the blade you will see the <img src="Pictures/10.png" alt="drawing" width="70px"/>, click next.In the next section you will need to modify the route.  Enter the following:```{  "routes": {    "upstream": "FROM /* INTO $upstream"  }}```Click <img src="Pictures/10.png" alt="Next.jpg"  width="70px"/>Click <img src="Pictures/11.png" alt="Submit" width="70px"/>Check to see if the data is flowing in to the IoT hub.  To do this we will type the following command at the shell prompt on the Finally, for more information you can view this [article](https://github.com/Azure/iot-edge-opc-publisher), and this [article](https://hub.docker.com/r/microsoft/iot-edge-opc-publisher/)